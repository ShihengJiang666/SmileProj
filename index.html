<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.12: http://docutils.sourceforge.net/" />
<title>Practice Testing with Spies and Mocks</title>
<link rel="stylesheet" href="pandoc.css" type="text/css" />
</head>
<body>
<div class="document" id="practice-testing-with-spies-and-mocks">
<h1 class="title">Practice Testing with Spies and Mocks</h1>

<script src='my_ga.js'></script>
<style>
    div.document {
        width: 800px;
        margin: 0 auto;
        line-height: 1.3;
        font-family: 'Open Sans',Arial,sans-serif;
    }
    div.important-request {
       border: solid black 1px;
       padding: 10px;
       background-color: #F5DFF3;
    }
</style><div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#acknowledgements" id="id1">Acknowledgements</a></li>
<li><a class="reference internal" href="#important-request" id="id2">Important Request</a></li>
<li><a class="reference internal" href="#initial-instructions" id="id3">Initial Instructions</a></li>
<li><a class="reference internal" href="#task-1-get-started-with-the-provided-files" id="id4">Task 1: Get Started with the Provided Files</a></li>
<li><a class="reference internal" href="#task-2-run-the-buses-application" id="id5">Task 2: Run the buses application</a></li>
<li><a class="reference internal" href="#task-3-run-the-initial-tests" id="id6">Task 3: Run the initial tests</a></li>
<li><a class="reference internal" href="#task-4-read-the-documentation-for-the-bond-spying-and-mocking-library" id="id7">Task 4: Read the documentation for the Bond spying and mocking library</a></li>
<li><a class="reference internal" href="#task-5-use-spying-for-a-simple-unit-test" id="id8">Task 5: Use spying for a simple unit test</a></li>
<li><a class="reference internal" href="#task-6-write-the-first-mock" id="id9">Task 6: Write the first mock</a></li>
<li><a class="reference internal" href="#task-7-write-a-more-complex-mock-for-reading-input" id="id10">Task 7: Write a more complex mock for reading input</a></li>
<li><a class="reference internal" href="#task-8-writing-mocks-for-the-http-requests" id="id11">Task 8: Writing mocks for the HTTP requests</a></li>
<li><a class="reference internal" href="#task-9-some-code-maintenance" id="id12">Task 9: Some code maintenance</a></li>
<li><a class="reference internal" href="#final-thoughts" id="id13">Final Thoughts</a></li>
</ul>
</div>
<p>In this homework you will write tests with mocking for a simple application that we provide.
The application finds out what are the closest buses to a particular stop on a bus route, e.g.,
the 51B route (Alameda County Transit Authority). The app first prompts the user to select
the stop among the list of stops on the route.</p>
<img alt="bus_stop.jpg" src="bus_stop.jpg" style="height: 200px;" />
<p>The app works by finding out the geographic coordinates of the desired bus stop, and the live locations
of the buses on that route. Using the geographic coordinates the app will estimate the (straight line)
distance from each bus to the bus stop and will compute a list of running buses sorted on the increasing
distance to the bus stop.</p>
<p>Disclaimer: There are certainly approximations in this app, perhaps even bugs.
From now on, you can blame this app when you arrive late to lecture.</p>
<div class="section" id="acknowledgements">
<h1><a class="toc-backref" href="#id1">Acknowledgements</a></h1>
<p>The idea for this particular application came from Jonathan Indig and Davis Shepherd.</p>
<p>Erik Krogen helped design and implement the <a class="reference external" href="http://necula01.github.io/bond/">Bond spying library</a> that you will use.</p>
<p>The data for bus stops and running buses is obtained from <a class="reference external" href="http://nextbus.cubic.com/About/Vision">http://nextbus.cubic.com/About/Vision</a>. For details
on the API please see <a class="reference external" href="https://www.nextbus.com/xmlFeedDocs/NextBusXMLFeed.pdf">https://www.nextbus.com/xmlFeedDocs/NextBusXMLFeed.pdf</a> (although you do not really
need to look at that document to complete this assignment).</p>
</div>
<div class="section" id="important-request">
<h1><a class="toc-backref" href="#id2">Important Request</a></h1>
<div class="important-request container">
The project is provided as is to anybody who wants to learn mocking. However, we ask
that you do not post the solutions in any location that is searchable. Please do not push these solutions
to a public GitHub repository. We would like everybody who wants to do this project in the future
to have the same pristine experience that you are having now.</div>
</div>
<div class="section" id="initial-instructions">
<h1><a class="toc-backref" href="#id3">Initial Instructions</a></h1>
<ol class="arabic simple">
<li><strong>Read and follow all instructions.</strong></li>
<li><strong>This Quiz is quite a bit more involved than other quizzes</strong>, because it
involves programming. There is some reading you need to do, and some
programming. It will take at least 2 hours, but may take quite a bit more.<ul>
<li>You should start early. We will consider the commit history for re-grade
requests.</li>
</ul>
</li>
<li>There is a Quiz Form associated with this homework. You will have to fill in the Quiz after you
do the homework. Make sure you read the Quiz before, to have an idea what you will have to answer.</li>
<li>At various points in this write-up we will ask you to commit and push your commits to your repository. Part
of the grading will consider your revision history.</li>
</ol>
</div>
<div class="section" id="task-1-get-started-with-the-provided-files">
<h1><a class="toc-backref" href="#id4">Task 1: Get Started with the Provided Files</a></h1>
<p>To help you start we have provided some boilerplate files that you will have to
modify to implement the project.</p>
<ul>
<li><p class="first">This homework has been developed on Mac OS X and most likely it runs on
Linux as well. You can probably use Windows with an installation
of <tt class="docutils literal">python</tt> and/or <tt class="docutils literal">ruby</tt>, but we have not tested this on Windows.
You will need at least the <tt class="docutils literal">diff</tt> command line tool. Your mileage may vary.</p>
</li>
<li><p class="first">Download the support files (<a class="reference external" href="cs169_testdriven_hw.tar.gz">tarball</a>)</p>
<ul class="simple">
<li>Unpack this file and push the initial version to the <tt class="docutils literal">testdriven_hw</tt> branch of your private GitHub repo:</li>
</ul>
<pre class="code literal-block">
tar xvfz cs169_testdriven_hw.tar.gz
cd cs169_testdriven_hw
git init
git remote add origin https://github.com/ucbcs169fa15/xx.git      ### Replace 'xx' with your class account
git add .
git commit -am&quot;Initial version&quot;
git push origin HEAD:testdriven_hw
</pre>
</li>
<li><p class="first">This project can be done either in Python or in Ruby. Once you unpacked the
files you will see the following directory structure.</p>
<table border="1" class="docutils">
<caption>Test</caption>
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<tbody valign="top">
<tr><td><tt class="docutils literal">index.html</tt></td>
<td>This document</td>
</tr>
<tr><td><tt class="docutils literal">py</tt></td>
<td>Files for the Python version of the assignment</td>
</tr>
<tr><td><tt class="docutils literal">py/buses.py</tt></td>
<td>The buses app</td>
</tr>
<tr><td><tt class="docutils literal">py/buses_tests.py</tt></td>
<td>The tests for buses app</td>
</tr>
<tr><td><tt class="docutils literal">py/bond.py</tt></td>
<td>The Bond library (Python)</td>
</tr>
<tr><td><tt class="docutils literal">py/bond_reconcile.py</tt></td>
<td>The Bond library (Python)</td>
</tr>
<tr><td><tt class="docutils literal">rb</tt></td>
<td>Files for the Ruby version of the assignment</td>
</tr>
<tr><td><tt class="docutils literal">rb/buses.rb</tt></td>
<td>The buses app</td>
</tr>
<tr><td><tt class="docutils literal">rb/buses_spec.py</tt></td>
<td>The RSpec tests for buses app</td>
</tr>
<tr><td><tt class="docutils literal">rb/bond.rb</tt></td>
<td>The Bond library (Ruby)</td>
</tr>
<tr><td><tt class="docutils literal">rb/bond/bond_targetable.rb</tt></td>
<td>The Bond library; contains function annotation code (Ruby)</td>
</tr>
<tr><td><tt class="docutils literal">rb/bond/bond_spec_helper.rb</tt></td>
<td>The Bond library; contains RSpec helper code (Ruby)</td>
</tr>
<tr><td><tt class="docutils literal">bin/bond_reconcile.py</tt></td>
<td>Part of the Bond library invoked by Ruby</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">(Optional, but recommended) You should install the tool <tt class="docutils literal">kdiff3</tt> if you
have not installed it already. It is a generally good tool for any kind of
merging, including using for <tt class="docutils literal">git mergetool</tt>. Make sure to add the
installation directory to the PATH so that you can invoke the tool from the
terminal.</p>
<ul>
<li><p class="first">Visit the <a class="reference external" href="http://kdiff3.sourceforge.net/">Kdiff3 web site</a></p>
</li>
<li><p class="first">For Mac, this involves downloading and installing the DMG file, and then
adding to your PATH environment variable <tt class="docutils literal">/Applications/kdiff3.app/Contents/MacOS/kdiff3</tt></p>
<pre class="code literal-block">
kdiff3    #  should open the kdiff3 window
</pre>
</li>
</ul>
<p>If you do install <tt class="docutils literal">kdiff</tt> you can use it in place of the default
<tt class="docutils literal">console</tt> by using <tt class="docutils literal">BOND_RECONCILE=kdiff3</tt> instead of
<tt class="docutils literal">BOND_RECONCILE=console</tt> in the command line (see below).</p>
</li>
</ul>
</div>
<div class="section" id="task-2-run-the-buses-application">
<h1><a class="toc-backref" href="#id5">Task 2: Run the buses application</a></h1>
<p>Try out the application to undestand what it does, and to make sure it works properly:</p>
<ul>
<li><p class="first">For Python</p>
<blockquote>
<pre class="code literal-block">
python buses.py
</pre>
</blockquote>
</li>
<li><p class="first">For Ruby</p>
<blockquote>
<pre class="code literal-block">
ruby buses.rb
</pre>
</blockquote>
</li>
</ul>
<p>You should see a list of stops on the 51B bus route through Berkeley, and a
prompt to pick one of the stops. If you enter something that is not a number
in the required range, the interactive loop will repeat. Once you pick the
stop, you should see a list of a few buses that are currently running that
route sorted in increasing order of the distance from the bus stop you picked.</p>
<p>Note: if you try to do this part at night, when the 51B bus is not running,
you may not get any running buses. You can change the code to use the route
851 (an all nighter) in that case.</p>
<p>Take a look at the code for the app, it should be easy to follow.</p>
<p>In the rest of the assignment, you will have to write the tests for this app. Ideally, the person
who wrote the app would have used test-driven development and the app would
have tests already. But, alas, not everybody took CS169 !</p>
</div>
<div class="section" id="task-3-run-the-initial-tests">
<h1><a class="toc-backref" href="#id6">Task 3: Run the initial tests</a></h1>
<p>We provided a skeleton test framework for you to use.</p>
<ul>
<li><p class="first">For Python</p>
<p>The tests are in the file <tt class="docutils literal">buses_tests.py</tt> and are using the Python <tt class="docutils literal">unittest</tt> test framework.</p>
<blockquote>
<pre class="code literal-block">
python buses_tests.py
</pre>
</blockquote>
</li>
<li><p class="first">For Ruby</p>
<p>The tests are in the file <tt class="docutils literal">buses_spec.rb</tt> and are using the Ruby <tt class="docutils literal">rspec</tt> test framework.
You may need to install this gem using <tt class="docutils literal">gem install rspec</tt>.</p>
<blockquote>
<pre class="code literal-block">
rspec buses_spec.rb
</pre>
</blockquote>
</li>
</ul>
<p>You should see one test passing <tt class="docutils literal">test_distance_computation</tt>.</p>
</div>
<div class="section" id="task-4-read-the-documentation-for-the-bond-spying-and-mocking-library">
<h1><a class="toc-backref" href="#id7">Task 4: Read the documentation for the Bond spying and mocking library</a></h1>
<p>For this homework you will use a library called <a class="reference external" href="http://necula01.github.io/bond/">Bond</a>. You do not have to install Bond because
it has been packaged with your assignment. Familiarize yourself
with the library:</p>
<ul class="simple">
<li><a class="reference external" href="http://necula01.github.io/bond/tutorial.html">Read the Bond tutorial</a></li>
<li><a class="reference external" href="http://necula01.github.io/bond/example_heat.html">Read the Bond example</a></li>
<li><a class="reference external" href="http://necula01.github.io/bond/api.html">Skim the API documentation</a> You
will have to refer back to the API documentation as you are working on this
assignment.</li>
</ul>
</div>
<div class="section" id="task-5-use-spying-for-a-simple-unit-test">
<h1><a class="toc-backref" href="#id8">Task 5: Use spying for a simple unit test</a></h1>
<ol class="arabic">
<li><p class="first">Use <tt class="docutils literal">bond.spy</tt> to replace the assertions in the unit test <tt class="docutils literal">test_distance_computation</tt> /
<tt class="docutils literal">should properly compute distance between points</tt>. You can use a single call to spy,
in place of the 3 calls to <tt class="docutils literal">assertEquals</tt> / <tt class="docutils literal">expect</tt>.</p>
</li>
<li><ul class="first simple">
<li>For Python: You must initialize the bond library by calling <tt class="docutils literal">bond.start_test</tt> in your test.</li>
<li>For Ruby:<ul>
<li>You must install RSpec: <tt class="docutils literal">gem install rspec</tt></li>
<li>You must <tt class="docutils literal">include_context :bond</tt> in your RSpec <tt class="docutils literal">describe</tt>
block. We have prepared this for you, all you have is to uncomment the
line.</li>
</ul>
</li>
</ul>
</li>
<li><p class="first">Now run the tests, this time setting the environment variable
<tt class="docutils literal">BOND_RECONCILE</tt> to the value <tt class="docutils literal">console</tt> (or <tt class="docutils literal">kdiff3</tt> if you installed
it).
You can use any method you know for setting the environment
variable. In our examples, we will just set the environment variable
at the begining of the shell command for running the tests:</p>
<ul>
<li><p class="first">For Python:</p>
<pre class="code literal-block">
BOND_RECONCILE=console python buses_tests.py
</pre>
</li>
<li><p class="first">For Ruby:</p>
<pre class="code literal-block">
BOND_RECONCILE=console rspec buses_spec.rb
</pre>
</li>
</ul>
<p>For the rest of this assignment this is how you should run the tests.</p>
</li>
<li><p class="first">You will be prompted to accept the new spy observations. Verify that they are
correct (same values as what you had in <tt class="docutils literal">assertEquals</tt> / <tt class="docutils literal">expect</tt>), and then
accept the changes. Hint: In <tt class="docutils literal">kdiff3</tt> you can accept change individually by
clicking on the red up/down arrows to position to the next difference, and click
B to accept the new observations (shown in panel B in the UI). You can accept all
changes by going to the <tt class="docutils literal">Merge</tt> menu.</p>
</li>
<li><p class="first">You will now see a subdirectory called <tt class="docutils literal">test_observations</tt>.</p>
</li>
<li><p class="first">Add the <tt class="docutils literal">test_observations</tt> directory to git, commit with the
message &quot;Task 5&quot;. We will want to see this commit in your git history.</p>
</li>
</ol>
</div>
<div class="section" id="task-6-write-the-first-mock">
<h1><a class="toc-backref" href="#id9">Task 6: Write the first mock</a></h1>
<p>Next you will write a test for the <tt class="docutils literal">select_stop_interactive</tt> function. This
function takes a list of bus-stop records with fields like <tt class="docutils literal">lat</tt>, <tt class="docutils literal">lon</tt>, and
<tt class="docutils literal">title</tt>, prints a menu of stops, indexed from 1 to however many there are,
prompts the user to enter a valid stop index, and then returns the record
corresponding to that index.</p>
<ol class="arabic simple">
<li>Add to the testing module a new test named <tt class="docutils literal">test_select_stop_0</tt>
(for Ruby, <tt class="docutils literal">it 'should select the first bus when stop 1 is specified'</tt>). In this
test you will call the <tt class="docutils literal">select_stop_interactive</tt>. You should write code
in the test to construct a list of two bus-stop records and pass it to the function.</li>
<li>Add to your test a call to Bond to spy the value returned from the function
(instead of adding asserts that the call returns a record with the right fields)</li>
<li>If you try to run the test at this point, it is going to wait for
user input. This is not acceptable in automated tests.
You will need to intercept this operation and
mock the response to &quot;1&quot; (to select the first stop).<ul>
<li>The app code has already been refactored to allow
you to insert a spy point for mocking with Bond the reading from the
console.</li>
<li>The spy point should spy its result (we want to save in the observations
the returned value).</li>
<li>Also, we want to tell the spy point to abort the execution if there is no
mock result, since we never want to actually wait for user input in
automated tests.</li>
<li>The test code should deploy an agent to provide a mock result for
reading from the console.  In Bond, an agent must specify the precise spy point
name. The spy point name is by default <tt class="docutils literal">MODULE_NAME.FUNCTION_NAME</tt>.</li>
<li>See the <a class="reference external" href="http://necula01.github.io/bond/api.html">Bond API documentation</a> for how to achieve this.</li>
</ul>
</li>
<li>Run the tests, verify and accept the initial observations for the new test.</li>
<li>Add the new observation files to <tt class="docutils literal">git</tt>, commit with the message &quot;Task 6&quot;.</li>
</ol>
</div>
<div class="section" id="task-7-write-a-more-complex-mock-for-reading-input">
<h1><a class="toc-backref" href="#id10">Task 7: Write a more complex mock for reading input</a></h1>
<p>The <tt class="docutils literal">select_stop_interactive</tt> function contains logic to reject invalid
input and re-prompt the user. Now you will write a test to exercise that
logic.</p>
<p><strong>Please note that this task is a bit trickier that others. The subsequent tasks
do not depend on it.</strong></p>
<ol class="arabic simple">
<li>Add to the testing module a new test named <tt class="docutils literal">test_select_stop_retries</tt>
(for Ruby, <tt class="docutils literal">it 'should retry when an invalid bus selection is given'</tt>).
In this test you will call the <tt class="docutils literal">select_stop_interactive</tt>, using the same
input data as for the previous test.</li>
<li>Add to your test a call to Bond to spy the value returned from the function
(instead of adding asserts that it returns a record with the right fields).</li>
<li>You need to deploy a slightly more complex agent for the spy point that you
used also for Task 6.<ul>
<li>The first time the user is prompted for input, your mock should return
the string &quot;a&quot;. This will force the logic to retry.</li>
<li>On second call, the mock should return &quot;&quot; (empty string). This will
also force the logic to retry.</li>
<li>On third call, the mock should return &quot;3&quot;. This will
also force the logic to retry, because the index is too large.</li>
<li>On third call, the mock should return &quot;0&quot;. This will
also force the logic to retry, because the index is too small.</li>
<li>On fourth call, the mock should return &quot;2&quot;. This should be a valid input
and the code should return the second stop record.</li>
<li>Hints:<ul>
<li>Writing the logic for this mock can be a bit tricky, but the shortest
solution is just 2 lines.</li>
<li>Your agent should use a function as a <tt class="docutils literal">result</tt> parameter.</li>
<li>The function should be written to return &quot;a&quot; the first time it is
called, &quot;&quot; the second time, etc.</li>
</ul>
</li>
<li>Note that this test should find a bug in the app code. Fix it, to make
the test pass.</li>
</ul>
</li>
<li>Run the tests, verify and accept the initial observations for the new test</li>
<li>Add the new observation files to <tt class="docutils literal">git</tt>, commit with the message &quot;Task 7&quot;.</li>
</ol>
</div>
<div class="section" id="task-8-writing-mocks-for-the-http-requests">
<h1><a class="toc-backref" href="#id11">Task 8: Writing mocks for the HTTP requests</a></h1>
<p>Now we are going to test the main function, <tt class="docutils literal">get_closest_buses</tt>. There are
no new concepts for this part, it is going to be similar mocking as for the
previous two tasks.</p>
<ol class="arabic simple">
<li>Add to the testing module a new test named <tt class="docutils literal">test_integration</tt>
(for Ruby, <tt class="docutils literal">it 'should integrate correctly'</tt>). In this test you will
call the <tt class="docutils literal">get_closest_buses</tt>, with no arguments, and you should spy the result.</li>
<li>You need to add a spy point to intercept the two HTTP requests. Your spy point
should:<ul>
<li>observe the parameters of the request</li>
<li>not observe the result of the request (it is big)</li>
<li>declare that it needs a mock result, or else the
execution should fail. We don't want actual HTTP requests during testing.</li>
</ul>
</li>
<li>In your test you will need to deploy two agents, one for each kind of
request<ul>
<li>Your agents will have to provide mock results for the two HTTP requests.</li>
<li>To get good samples, run the buses app directly, and you will see that it
prints the URLs that it is accessing. Use a command-line tool (e.g.,
curl) to make the same request and get the output. (Be careful to quote
the URL when you use it on the command line, because it contains
characters such as '&amp;' which are special in the shell.)</li>
<li>The <cite>routeConfig</cite> output is big, you only need the first 3 stops or so
for your integration test. But when you extract that fragment be careful
to preserve the XML file structure.</li>
<li>When you copy the XML output in your test, be careful to use multi-line
strings, e.g., <tt class="docutils literal"><span class="pre">&quot;&quot;&quot;...&quot;&quot;&quot;</span></tt> in Python or <tt class="docutils literal"><span class="pre">%q(...)</span></tt> in Ruby.</li>
</ul>
</li>
<li>Run the tests, verify and accept the initial observations for the new test.</li>
<li>Add the new observation files to <tt class="docutils literal">git</tt>, commit with the message &quot;Task 8&quot;.</li>
</ol>
</div>
<div class="section" id="task-9-some-code-maintenance">
<h1><a class="toc-backref" href="#id12">Task 9: Some code maintenance</a></h1>
<p>You think you are done, but your product manager has just woken up with this
nightmare that he was made to promise at gun-point that the buses application
will be changed to provide the answers in kilometers instead of miles.</p>
<img alt="nightmare.jpeg" class="align-right" src="nightmare.jpeg" style="height: 200px;" />
<p>So, he
askes you to change to kilometers. Oh, no! The code change is small but all
these precise tests will have to be changed. No sweat, you call in 007.</p>
<ol class="arabic simple">
<li>Change the function <tt class="docutils literal">compute_lat_long_distance</tt> to replace the variable
<tt class="docutils literal">earth_radius</tt> from 3961 (miles) to 6373 (kilometers). That is all you
need to change in the code.</li>
<li>Re-run all your tests, and let Bond prompt you to accept the new
observations. Inspect them then accept the new reference values.</li>
<li>Add the new observation files to <tt class="docutils literal">git</tt>, commit with the message &quot;Task 9&quot;.</li>
</ol>
</div>
<div class="section" id="final-thoughts">
<h1><a class="toc-backref" href="#id13">Final Thoughts</a></h1>
<p>Fill in and submit the Quiz Form associated with this assignment.</p>
<p>Do not forget to push you local git commits to the private CS169 GitHub repository.</p>
<p>We hope that you will use mocking when testing your future projects.</p>
</div>
</div>
</body>
</html>
